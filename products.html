<script>
    const _supabase = supabase.createClient('https://wwbyzuvbqamucptnnlpf.supabase.co', 'sb_publishable_-hyuI4B77eb_uorLPMhfAg_8SvHM7Z2');
    
    async function loadProducts() {
        const { data: { user } } = await _supabase.auth.getUser();
        // جلب المنتجات مرتبة من الأحدث للأقدم
        const { data: products } = await _supabase.from('products').select('*').eq('merchant_id', user.id).order('created_at', { ascending: false });

        const list = document.getElementById('mainProductList'); // تأكد أن هذا الـ ID موجود في HTML
        list.innerHTML = '';

        products.forEach(p => {
            // ✅ الحل الجذري لمسار الصورة
            const bucketBase = "https://wwbyzuvbqamucptnnlpf.supabase.co/storage/v1/object/public/products-bucket/";
            const finalImg = p.image_url ? (p.image_url.includes('http') ? p.image_url : bucketBase + p.image_url) : 'https://via.placeholder.com/80/FF0000/FFFFFF?text=M';

            list.innerHTML += `
                <div class="p-card">
                    <img src="${finalImg}" class="p-img" onerror="this.src='https://via.placeholder.com/80/FF0000/FFFFFF?text=M'">
                    <div class="p-info">
                        <h3>${p.name}</h3>
                        <p>${p.price} ريال</p>
                    </div>
                    <div class="stock-badge">الكمية: ${p.stock}</div>
                </div>`;
        });
    }
    document.addEventListener('DOMContentLoaded', loadProducts);
</script>
