<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M - NEW INVENTORY</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* إلغاء كل شيء قديم والبدء بصفحة بيضاء صافية [cite: 2026-01-30] */
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 20px 10px; font-family: 'Cairo', sans-serif; background: #ffffff; color: #000; }

        /* رأس الصفحة الجديد: أرقام كبيرة وواضحة بدون صناديق [cite: 2026-01-22] */
        .new-header { display: flex; justify-content: space-around; border-bottom: 1.5px solid #000; padding-bottom: 15px; margin-bottom: 25px; }
        .stat { text-align: center; }
        .stat b { display: block; font-size: 24px; line-height: 1; margin-bottom: 5px; }
        .stat span { font-size: 10px; font-weight: 700; color: #888; letter-spacing: 1px; }

        /* تقسيم المجموعات الجديد */
        .group-label { font-size: 14px; font-weight: 900; margin: 20px 0 10px; color: #000; text-transform: uppercase; }

        /* شبكة M الصارمة: 3 مربعات صغيرة جداً لا تقبل التمدد [cite: 2026-01-22] */
        .m-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            row-gap: 15px;
        }

        .m-item { position: relative; display: flex; flex-direction: column; }

        /* تصميم المربع الجديد */
        .m-thumb { 
            width: 100%; 
            aspect-ratio: 1/1; 
            background: #f0f0f0; 
            border-radius: 8px; 
            overflow: hidden; 
            position: relative;
            border: 0.5px solid #eee;
        }
        .m-thumb img { width: 100%; height: 100%; object-fit: cover; }

        /* زر التعديل الجديد (✎) - أيقونة عائمة بذكاء [cite: 2026-01-22] */
        .quick-edit { 
            position: absolute; top: 4px; left: 4px; 
            background: #000; color: #fff; width: 20px; height: 20px; 
            border-radius: 5px; display: flex; align-items: center; 
            justify-content: center; font-size: 10px; text-decoration: none; 
            z-index: 10; border: none;
        }

        /* تفاصيل المنتج تحت المربع */
        .m-meta { padding-top: 5px; text-align: right; }
        .m-n { font-size: 9px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .m-p { font-size: 10px; font-weight: 900; color: #ff0000; }
        
        /* ملصق الكمية الصغير جداً */
        .m-qty-tag { position: absolute; top: 4px; right: 4px; background: rgba(255,255,255,0.9); color: #000; font-size: 7px; padding: 1px 4px; border-radius: 3px; font-weight: 900; z-index: 5; border: 0.5px solid #ddd; }
        .m-qty-tag.empty { background: #ff0000; color: #fff; border: none; }

        /* زر الإضافة الجديد: دائرة سوداء بسيطة وصلبة */
        .m-add { position: fixed; bottom: 25px; left: 25px; width: 50px; height: 50px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; }
    </style>
</head>
<body>

    <div class="new-header">
        <div class="stat"><b id="allCount">0</b><span>TOTAL</span></div>
        <div class="stat"><b id="lowCount" style="color:#ffae42">0</b><span>LOW</span></div>
        <div class="stat"><b id="outCount" style="color:#ff0000">0</b><span>OUT</span></div>
    </div>

    <div id="outBox" style="display:none;">
        <div class="group-label" style="color:#ff0000;">● منتهية</div>
        <div class="m-grid" id="outGrid"></div>
    </div>

    <div class="group-label">● المخزون الحالي</div>
    <div class="m-grid" id="allGrid"></div>

    <a href="add-product.html" class="m-add">+</a>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const _s = supabase.createClient('https://wwbyzuvbqamucptnnlpf.supabase.co', 'sb_publishable_-hyuI4B77eb_uorLPMhfAg_8SvHM7Z2');

        async function loadNew() {
            const { data: { user } } = await _s.auth.getUser();
            const { data: items } = await _s.from('products').select('*').eq('merchant_id', user.id).order('created_at', {ascending: false});
            
            let aH = '', oH = '', cOut=0, cLow=0;
            const path = "https://wwbyzuvbqamucptnnlpf.supabase.co/storage/v1/object/public/products-bucket/";

            items.forEach(i => {
                const img = i.image_url ? (i.image_url.includes('http') ? i.image_url : path + i.image_url) : 'https://via.placeholder.com/100';
                const isOut = i.stock == 0;
                if(isOut) cOut++; else if(i.stock <= 3) cLow++;

                const html = `
                    <div class="m-item">
                        <div class="m-qty-tag ${isOut?'empty':''}">${i.stock} Q</div>
                        <div class="m-thumb">
                            <img src="${img}" onerror="this.src='https://via.placeholder.com/100'">
                            <a href="edit-product.html?id=${i.id}" class="quick-edit">✎</a>
                        </div>
                        <div class="m-meta">
                            <div class="m-n">${i.name}</div>
                            <div class="m-p">${i.price} SAR</div>
                        </div>
                    </div>`;
                aH += html;
                if(isOut) oH += html;
            });

            document.getElementById('allGrid').innerHTML = aH;
            document.getElementById('outGrid').innerHTML = oH;
            document.getElementById('allCount').innerText = items.length;
            document.getElementById('outCount').innerText = cOut;
            document.getElementById('lowCount').innerText = cLow;
            if(cOut > 0) document.getElementById('outBox').style.display = 'block';
        }
        loadNew();
    </script>
</body>
</html>
