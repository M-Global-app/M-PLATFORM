<script>
    const _s = supabase.createClient('https://wwbyzuvbqamucptnnlpf.supabase.co', 'sb_publishable_-hyuI4B77eb_uorLPMhfAg_8SvHM7Z2');

    async function renderStudio() {
        const { data: { user } } = await _s.auth.getUser();
        const { data: products } = await _s.from('products').select('*').eq('merchant_id', user.id).order('created_at', {ascending: false});
        
        let mainH = '', lowH = '', cOut=0, cLow=0;
        const storagePath = "https://wwbyzuvbqamucptnnlpf.supabase.co/storage/v1/object/public/products-bucket/";

        products.forEach(p => {
            const img = p.image_url ? (p.image_url.includes('http') ? p.image_url : storagePath + p.image_url) : 'https://via.placeholder.com/150';
            
            // تعديل الشرط: أي منتج 5 قطع أو أقل يعتبر "على وشك النفاذ"
            const outOfStock = p.stock == 0;
            const isLow = p.stock > 0 && p.stock <= 5; 

            if(outOfStock) cOut++;
            if(isLow) cLow++;

            const itemHtml = `
                <div class="m-card-new">
                    <div class="m-stock-label ${outOfStock ? 'alert' : (isLow ? 'warning' : '')}">${p.stock} Q</div>
                    <div class="m-frame">
                        <img src="${img}" onerror="this.src='https://via.placeholder.com/150'">
                        <a href="edit-product.html?id=${p.id}" class="m-edit-btn">✎</a>
                    </div>
                    <div class="m-content">
                        <div class="m-name-txt">${p.name}</div>
                        <div class="m-price-txt">${p.price} ريال</div>
                    </div>
                </div>`;

            mainH += itemHtml;
            // إضافة المنتج لقسم التنبيهات إذا كان منتهياً أو أوشك على النفاذ
            if(outOfStock || isLow) lowH += itemHtml;
        });

        document.getElementById('mainGrid').innerHTML = mainH;
        document.getElementById('lowGrid').innerHTML = lowH;
        document.getElementById('totalP').innerText = products.length;
        document.getElementById('outP').innerText = cLow + cOut; // تحديث عداد التنبيهات

        // إظهار القسم فقط إذا كان هناك منتجات تحتاج انتباهك
        if(lowH) {
            document.getElementById('lowSection').style.display = 'block';
        } else {
            document.getElementById('lowSection').style.display = 'none';
        }
    }
    renderStudio();
</script>

<style>
    /* إضافة لون برتقالي للمنتجات التي أوشكت على النفاذ */
    .m-stock-label.warning { background: #ffae42; color: #fff; }
</style>
