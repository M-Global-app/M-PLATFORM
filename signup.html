<script>
    // 1. وظيفة لجلب كود المسوق من الرابط تلقائياً
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref'); // يبحث عن ?ref=اسم_المسوق

    // 2. تحديث واجهة المستخدم إذا وجد مسوق (اختياري لتعزيز الثقة)
    if (refCode) {
        console.log("تم التسجيل عبر المسوق: " + refCode);
    }

    // 3. تعديل عملية الإرسال لـ Supabase لربط التاجر بالمسوق
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "جاري الحفظ...";
        btn.disabled = true;

        const { error } = await _supabase.auth.signUp({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            options: { 
                data: { 
                    phone: document.getElementById('phone').value, 
                    store_name: document.getElementById('storeName').value, 
                    plan: selectedPlan,
                    referrer: refCode || "direct" // إذا لم يوجد مسوق سيتم تسجيله كـ "مباشر"
                } 
            }
        });

        if (error) { 
            showAlert('خطأ!', error.message); 
            btn.innerText = "إنشاء متجري الآن"; 
            btn.disabled = false; 
        } else { 
            showAlert('مبروك!', 'تم إنشاء المتجر بنجاح ويرتبط بنظام العمولات.'); 
        }
    });
</script>
